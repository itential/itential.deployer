# Copyright (c) 2025, Itential, Inc
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)---
---
- name: Configure nginx
  hosts: nginx
  become: true

  tasks:
    - name: Configure nginx
      ansible.builtin.include_role:
        name: nginxinc.nginx_config

    # TODO: Use NGINX variables to properly configure SELINUX and remove redundant tasks.
    - name: Configure SELinux http_port_t for port {{ nginx_config_http_template[0].config.servers[0].core.listen[0].port }}
      community.general.seport:
        ports: "{{ nginx_config_http_template[0].config.servers[0].core.listen[0].port }}"
        proto: tcp
        setype: http_port_t
        state: present

    - name: Allow nginx to make network connections
      ansible.posix.seboolean:
        name: httpd_can_network_connect
        state: true
        persistent: true

    - name: Allow nginx to modify system files
      ansible.posix.seboolean:
        name: httpd_setrlimit
        state: true
        persistent: true

    - name: Open Port on FirewallD Public Zone
      ansible.posix.firewalld:
        port: "{{ nginx_config_http_template[0].config.servers[0].core.listen[0].port }}/tcp"
        permanent: true
        state: enabled
        zone: public
        immediate: true
      when:
        - ansible_facts.services["firewalld.service"] is defined
        - ansible_facts.services["firewalld.service"].state == "running"
        - ansible_facts.services["firewalld.service"].status == "enabled"

    - name: Restart nginx after configuration
      ansible.builtin.systemd:
        name: nginx
        state: restarted
        enabled: true
        daemon_reload: true

    - name: Assert that nginx is running
      ansible.builtin.systemd:
        name: nginx
      register: nginx_status
      failed_when: nginx_status.status.ActiveState != "active"
      tags: always
