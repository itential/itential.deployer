# Overview

The playbook and roles in this section install and configure Itential Platform.  There are currently two roles:

* `platform` – Installs Itential Platform and performs a base configuration.
* `platform_app_artifact` – Installs App Artifacts.

# Roles

## Platform Role

The `platform` role performs a base install of Itential Platform including any OS packages required. It includes the appropriate version of Python, Pip, Jinja, and TextFSM. It handles a few security vulnerabilities. It creates the appropriate Linux users, directories, log files, and systemd services. It will start the automation-platform service when complete.

When there is a device configured in the `gateway` group this role will also install and configure an IAG adapter that points to the gateway server(s) named in the `gateway` group.

## Platform Adapters Role

The `platform_adapters` role will install the source code for each adapter that is listed.  It will also install any listed custom adapters.  It can install from a Git URL or using an adapter archive generated by Adapter Builder.  It will restart the automation-platform service when complete.

## Platform App Artifact Role

The `platform_app_artifact` role will install app-artifacts, which is an optional Itential application that is primarily used only in development environments for packaging use cases together for deployment. It will restart the automation-platform service when complete.

# Variables

## Static Variables

The variables located in the `vars` directory of each role are "static" and not meant to be overridden by the user.  Since these variable files are included at run-time based on the Itential Platform release and OS major version, they have a higher precedence than the variables in the inventory and are not easily overridden.

| Variable | Group | Type | Description | Default Value
| :------- | :---- | :--- | :---------- | :------------
| `platform_install_dir` | `platform` | String | The Itential Platform installation directory. | `/opt/itential/platform/server`
| `platform_log_dir` | `platform` | String | The Itential Platform log directory. | `/var/log/itential`

## Global Variables

The variables in this section are configured in the inventory in the `all` group vars.

| Variable | Group | Type | Description | Default Value | Required?
| :------- | :---- | :--- | :---------- | :------------ | :--------
| `platform_release` | `all` | Fixed-point | Designates the Itential Platform major version. | N/A | Yes
| `platform_mongodb_root_ca_file_source` | `all` | String | The name of the MongoDB Root CA file.| N/A | No

The `platform_release` must be defined in the inventory.  This variable, along with the OS major version, is used to determine the static variables.

## Common Variables

The variables in this section may be overridden in the inventory in the `all` group vars.

The following table lists the default variables that are shared between the Platform-related roles, located in `roles/common_vars/defaults/main/platform.yml`.

| Variable | Group | Type | Description | Default Value
| :------- | :---- | :--- | :---------- | :------------
| `platform_mongodb_root_ca_file_destination` | `all` | String | The location of the Root CA file for MongoDB. | `/opt/itential/keys/mongo-rootCA.pem`

## Platform Role Variables

The variables in this section may be overridden in the inventory in the `platform` group vars.

| Variable | Group | Type | Description | Default Value | Required?
| :------- | :---- | :--- | :---------- | :------------ | :--------
| `platform_packages` | `platform` | List of Strings | The Itential Platform RPMs to install.<br>The items can either be filenames or URLs. | N/A | Yes
| `repository_username` | `platform` | String | The username for authentication of the repository. | N/A | No
| `repository_password` | `platform` | String | The password for authentication of the repository. | N/A | No
| `repository_api_key` | `platform` | String | The API for authentication of the repository. Can be used instead of username/password for authentication.| N/A | No
| `platform_redis_svc_url` | `platform` | String | This variable defines the redis service url to use when connecting to an externally provided redis cluster. It is intended to be used when the architecture demands that redis be hosted elsewhere such as when using Elasticache or if the demands of an organization require some other external redis solution, like a shared service. | N/A | No
| `platform_mongodb_svc_url_itential` | `platform` | String | This variable defines the mongodb connection string to use when connecting to the "itential" database. It is intended to be used when the architecture demands that mongo be hosted elsewhere such as when using Mongo Atlas or if the demands of an organization require some other external mongo solution, like a shared service. | N/A | No
| `platform_mongobdb_svc_url_localaaa` | `platform` | String | This variable defines the mongodb connection string to use when connecting to the "LocalAAA" database. It is intended to be used when the architecture demands that mongo be hosted elsewhere such as when using Mongo Atlas or if the demands of an organization require some other external mongo solution, like a shared service. | N/A | No

If `platform_packages` contains URLs, either `repository_api_key` or `repository_username` and `repository_password` must be defined.

The following table lists the default variables located in `roles/platform/defaults/main.yml`.

| Variable | Group | Type | Description | Default Value
| :------- | :---- | :--- | :---------- | :------------
| `platform_https` | `platform` | Boolean | Flag to enable HTTPS. | `false`
| `platform_http_port` | `platform` | Integer | The Itential Platform HTTP listen port. | `3000`
| `platform_https_port` | `platform` | Integer | The Itential Platform HTTPS listen port. | `3443`
| `platform_bootstrap_configs` | `platform` | Boolean | Flag to enabled adding default configurations in MongoDB. | `true`
| `platform_configure_iag_adapters` | `platform` | String | Flag to enable automatically configuring IAG adapters. | `true`
| `platform_iag_adapter_token_timeout` | `platform` | String | IAG adapter authentication token timeout.<br>Defines how long a token is valid in milliseconds. | `3600000`
| `platform_user` | `platform` | String | The Itential Platform Linux user. | `itential`
| `platform_group` | `platform` | String | The Itential Platform Linux group. | `itential`
| `platform_configure_vault` | `platform` | Boolean | Flag to configure Vault. When set to to `true`, Itential Platform will use Hashicorp Vault. | `false`
| `platform_vault_token_dir` | `platform` | String | The directory where the Vault token is stored. | `{{ platform_install_dir }}/vault`
| `platform_process_tasks_on_start` | `platform` | Boolean | Flag to enable processing tasks on startup. | `true`
| `platform_process_jobs_on_start` | `platform` | Boolean | Flag to enable processing jobs on startup. | `true`
| `platform_upload_using_rsync` | `platform` | Boolean | Flag to enable using rsync to upload artifacts.  <br>When set to `true`, rsync will be used.  <br>When set to `false`, secure copy will be used. | `false`
| `platform_redis_db_number` | `platform` | Integer | Default redis db number. | `0`

## Platform Adapters Role Variables

The variables in this section may be overridden in the inventory in the `platform` group vars.

The following table lists the default variables located in `roles/platform_adapters/defaults/main.yml`.

| Variable | Group | Type | Description | Default Value
| :------- | :---- | :--- | :---------- | :------------
| `platform_adapters` | `platform` | List of Strings | The URLs of the Itental adapter Git repo.<br>OR<br>The zip archives from Adapter Builder. | N/A
| `platform_delete_package_lock_file` | `platform` | Boolean | Flag to enable deletion of NPM package lock file before installing NPM module. | `true`
| `platform_disable_git_safe_repo_check` | `platform` | Boolean | Flag to disable the Git safe repo check. | `true`
| `platform_npm_ignore_scripts` | `platform` | Boolean | Flag to enable ignoring the scripts when installing NPM modules. | `true`
## Platform App Artifacts Role Variables

The variables in this section may be overridden in the inventory in the `platform` group vars.

The following table lists the default variables located in `roles/platform_app_artifact/defaults/main.yml`.

| Variable | Group | Type | Description | Default Value
| :------- | :---- | :--- | :---------- | :------------
| `platform_app_artifact` | `platform` | Boolean | Flag for enabling the installation of App Artifact. | `false`
| `platform_app_artifact_source_file` | `platform` | String | The name of the App-Artifact archive.  The archive must be placed in the `files` directory. | N/A

# Building the Inventory

To install and configure Itential Platform, add a `platform` group and host(s) to your inventory and configure the `platform_release` and `platform_packages`. The URLs in `platform_packages` supports Sonatype Nexus, JFrog Artifactory and Gitlab. It is recommended to use `repository_username` and `repository_password` for Nexus and `repository_api_key` for Artifactory and Gitlab.  The following inventory shows a basic Itential Platform configuration with a single node.

## Example Inventory - Single Itential Platform Node

```
all:
    vars:
        platform_release: 6.0

    children:
        platform:
            hosts:
                <host1>:
                    ansible_host: <addr1>
            vars:
                platform_packages:
                    - <rpm1>
                    - <rpmN>
```

To install Itential adapters, add the `platform_adapters` flag to the `platform` group and set it to `true`, and configure the adapters in the `platform_adapters` variable.

## Example Inventory - Install Adapters

```
all:
    vars:
        platform_release: 6.0

    children:
        platform:
            hosts:
                <host1>:
                    ansible_host: <addr1>
            vars:
                platform_packages:
                    - <rpm1>
                    - <rpmN>
                platform_adapters: true
                platform_adapters:
                    - <git_repo1>
                    - <git_repoN>
                    - <zip_archive1>
                    - <zip_archiveN>
                platform_custom_adapters:
                    - <git_repo1>
                    - <git_repoN>
                    - <zip_archive1>
                    - <zip_archiveN>
                platform_custom_location: <location>

To install App-Artifacts, add the `platform_app_artifact` flag to the `platform` group and set it to `true` and configure the `platform_app_artifact_source_file`.

## Example Inventory - Install App-Artifact

```
all:
    vars:
        platform_release: 2023.1

    children:
        platform:
            hosts:
                <host1>:
                    ansible_host: <addr1>
            vars:
                platform_bin_file: <bin-file>
                platform_app_artifact: true
                platform_app_artifact_source_file: <archive1>
```

## Example Inventory - Use Hashicorp Vault

```
all:
    vars:
        platform_release: 2023.1

    children:
        platform:
            hosts:
                <host1>:
                    ansible_host: <addr1>
            vars:
                platform_configure_vault: true
```

# Running the Playbook

To execute all Platform roles, run the `platform` playbook:

```
ansible-playbook itential.deployer.platform -i <inventory>
```

You can also run select platform roles by using the following tags:

* `platform_install`
* `platform_adapters`
* `platform_app_artifact`

To execute only the `platform` role, run the `itential.deployer.platform` playbook with the `platform_install` tag:

```
ansible-playbook itential.deployer.platform -i <inventory> --tags platform_install
```

To execute only the `platform_adapters` role, run the `itential.deployer.platform` playbook with the `platform_adapters` tag:

```
ansible-playbook itential.deployer.platform -i <inventory> --tags platform_adapters
```

To execute only the `platform_app_artifact` role, run the `itential.deployer.platform` playbook with the `platform_app_artifact` tag:

```
ansible-playbook itential.deployer.platform -i <inventory> --tags platform_app_artifact
```
