# Copyright (c) 2024, Itential, Inc
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
---
- name: Validate vars
  ansible.builtin.include_tasks:
    file: validate-vars.yml
  tags: always

- name: Install and configure Redis
  notify: Enable and Start Platform
  block:
    - name: Configure System
      tags: configure_system
      block:
        - name: Create itential user
          ansible.builtin.include_tasks:
            file: create-itential-user.yml

        - name: Create itential directories
          ansible.builtin.file:
            name: "{{ item }}"
            state: directory
            owner: "{{ platform_user }}"
            group: "{{ platform_group }}"
            mode: "0775"
          with_items:
            - "{{ platform_install_dir }}"
            - "{{ platform_config_dir }}"
            - "{{ platform_log_dir }}"

        - name: Ensure secure mode for TemplateBuilder
          ansible.builtin.lineinfile:
            path: /etc/sudoers
            insertafter: EOF
            state: present
            line: "{{ platform_user }} ALL=(ALL) NOPASSWD: /usr/sbin/chroot, /sbin/chroot"

        - name: Configure firewalld
          ansible.builtin.include_tasks:
            file: configure-firewalld.yml

    - name: Install Dependencies
      tags: install_dependencies
      notify: Update Itential release file
      block:
        - name: Install Platform package dependencies
          ansible.builtin.include_tasks:
            file: install-platform-packages.yml

        # - name: Install MongoDB tools
        #   ansible.builtin.include_tasks:
        #     file: install-mongodb-tools.yml

        - name: Install NodeJS
          ansible.builtin.include_tasks:
            file: install-nodejs.yml

        - name: Install Python
          ansible.builtin.include_tasks:
            file: install-python.yml

    - name: Install Platform
      tags: install_platform
      notify: Update Itential release file
      block:
        - name: Install Platform
          ansible.builtin.include_tasks:
            file: install-platform.yml

    - name: Configure SELinux
      ansible.builtin.include_tasks:
        file: configure-selinux.yml

    - name: Configure Platform
      tags: configure_platform
      block:
        - name: Create systemd file
          ansible.builtin.template:
            src: itential-platform.service.j2
            dest: /usr/lib/systemd/system/itential-platform.service
            owner: root
            group: root
            mode: "0644"

        - name: Create properties.json file
          ansible.builtin.include_tasks:
            file: create-properties-file.yml

        # - name: Set file ownership and permissions
        #   ansible.builtin.include_tasks:
        #     file: set-file-ownership.yml

        # This needs to run after set-file-ownership.yml so the permissions don't get over-written
        - name: Configure Vault
          ansible.builtin.include_tasks:
            file: configure-vault.yml
          when: platform_configure_vault | bool

        # - name: Copy certs
        #   ansible.builtin.include_tasks:
        #     file: copy-certs.yml

  # - name: Bootstrap Database
  #   tags: bootstrap
  #   block:
  #     - name: Initialize MongoDB with Itential Platform data
  #       ansible.builtin.include_tasks:
  #         file: mongo-init.yml
  #       when: platform_bootstrap_configs | bool
