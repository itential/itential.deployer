# Copyright (c) 2024, Itential, Inc
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
---
- name: Install NodeJS AL23 on Amazon Linux
  when: ansible_distribution == "Amazon"
  block:
    - name: Create temp working dir
      ansible.builtin.tempfile:
        state: directory
      register: workingdir

    - name: Download NodeJS repo install script
      ansible.builtin.get_url:
        url: "{{ platform_nodejs_url }}"
        dest: "{{ workingdir.path }}/{{ platform_nodejs_url | basename }}"
        mode: "0755"

    - name: Install NodeJS yum repo
      ansible.builtin.command: "{{ workingdir.path }}/{{ platform_nodejs_url | basename }}"
      changed_when: true

    - name: Remove workingdir
      ansible.builtin.file:
        path: "{{ workingdir.path }}"
        state: absent

- name: Download NodeJS RPMs
  ansible.builtin.import_role:
    name: offline
    tasks_from: download-rpms
  vars:
    offline_download_method: yum_module
    offline_download_packages: "{{ platform_nodejs_package | split }}"
    offline_download_dir: "{{ platform_offline_target_node_rpms_dir }}/nodejs"

- name: Copy RPMs to control node
  ansible.builtin.import_role:
    name: offline
    tasks_from: fetch-packages
  vars:
    offline_src_dir: "{{ platform_offline_target_node_rpms_dir }}/nodejs"
    offline_dest_dir: "{{ platform_offline_control_node_rpms_dir }}/nodejs"
