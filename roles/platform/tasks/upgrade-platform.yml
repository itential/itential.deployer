# Copyright (c) 2024, Itential, Inc
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
---
- name: Validate vars
  ansible.builtin.include_tasks:
    file: validate-vars.yml
  tags: always

# Install the new Itential Platform packages and update properties
- name: Upgrade platform and update service and properties
  notify:
    - Enable and Start Platform
    - Update Itential release file
  block:
    - name: Install Platform packages
      ansible.builtin.include_tasks:
        file: install-platform.yml

    - name: Configure Platform
      ansible.builtin.include_tasks:
        file: configure-platform.yml

- name: Ensure Itential Platform is running
  tags: always
  block:
    - name: Flush all handlers
      ansible.builtin.meta: flush_handlers

    - name: Start Itential Platform
      ansible.builtin.systemd:
        name: itential-platform
        state: started

    - name: Assert that Itential Platform is running
      ansible.builtin.systemd:
        name: itential-platform
      register: platform_status
      failed_when: platform_status.status.ActiveState != "active"
