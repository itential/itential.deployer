{# Sensible default SSL props #}
{% set acceptInvalidCerts = True %}
{% set checkServerIdentity = False %}
{% set sslCA = "" %}
{% set sslValidate = False %}
{% set sslEnabled = False %}
{#
Build the MongoDB connection string.
In the case where the user wants to bring their own database,
just use that. Else, build the connection string from the properties
defined in the host file.
#}
{% if platform_mongobdb_svc_url_localaaa is defined %}
  {% set url = platform_mongobdb_svc_url_localaaa %}
{% else %}
  {% set mongodb_hosts = [] %}
  {% if mongodb_replication_enabled | bool %}
    {% for h in groups['mongodb'] %}
      {{ mongodb_hosts.append( h + ":" + mongodb_port|string) }}
    {% endfor %}
    {% if groups["mongodb_arbiter"] is defined and groups["mongodb_arbiter"] | length > 0 %}
      {{ mongodb_hosts.append( hostvars [ groups["mongodb_arbiter"][0] ].inventory_hostname + ":" + mongodb_port|string ) }}
    {% endif %}
    {% set mongodb_hosts_str = mongodb_hosts|join(',') %}
    {% set url = "mongodb://" + mongodb_hosts_str + "/?replicaSet=" + mongodb_replset_name %}
  {% else %}
    {% set url = "mongodb://" + hostvars[ groups['mongodb'][0] ].inventory_hostname + ":" + mongodb_port|string %}
  {% endif %}
{% endif %}
{# Override TLS defaults if it is enabled #}
{% if mongodb_tls_enabled | bool %}
  {% set sslEnabled = True %}
  {% set acceptInvalidCerts = False %}
  {% set checkServerIdentity = True %}
  {% set sslValidate = True %}
  {% if platform_mongodb_root_ca_file_source is not defined %}
    {% set sslCA = "" %}
  {% else %}
    {% set sslCA = platform_mongodb_root_ca_file_destination %}
  {% endif %}
{% endif %}
{
  "isEncrypted": true,
  "loggerProps": {
    "console_level": "info",
    "description": "Logging",
    "log_directory": "{{ platform_log_dir }}",
    "log_filename": "local_aaa.log",
    "log_level": "info",
    "log_max_file_size": 10485760,
    "log_max_files": 10,
    "log_timezone_offset": 0,
    "syslog": {
      "app_name": "",
      "eol": "",
      "facility": "local0",
      "host": "127.0.0.1",
      "level": "warning",
      "localhost": "",
      "path": "",
      "pid": "process.pid",
      "port": 514,
      "protocol": "udp4",
      "type": "BSD"
    }
  },
  "model": "@itential/adapter-local_aaa",
  "name": "local_aaa",
  "properties": {
    "brokers": [
      "aaa"
    ],
    "groups": [],
    "id": "local_aaa",
    "properties": {
      "database": {
        "credentials": {
          "dbAuth": {{ mongodb_auth_enabled | bool | to_json }},
          "passwd": "{{ mongodb_user_localaaa_password }}",
          "user": "localaaa"
        },
        "db": "{{ mongodb_localaaa_db_name }}",
        "ssl": {
          "acceptInvalidCerts": {{ acceptInvalidCerts | bool | to_json }},
          "checkServerIdentity": {{ checkServerIdentity | bool | to_json }},
          "enabled": {{ sslEnabled | bool | to_json }},
          "sslCA": "{{ sslCA }}",
          "sslValidate": {{ sslValidate | bool | to_json }}
        },
        "url": "{{ url }}"
      }
    },
    "type": "local_aaa"
  },
  "type": "Adapter"
}
