# Copyright (c) 2024, Itential, Inc
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
---
# Get root token for Vault operations
- name: Get root key
  ansible.builtin.slurp:
    src: '{{ vault_root_key_dir }}/token.txt'
  register: root_key

# All Vault operations using root token
- name: Configure Vault AppRole with root token
  environment:
    VAULT_ADDR: "{{ vault_addr }}"
    VAULT_TOKEN: "{{ root_key.content | b64decode }}"
  block:
    # Step 1: Enable AppRole Auth Method
    - name: Check if AppRole auth method is enabled
      ansible.builtin.command: vault auth list -format=json
      register: auth_methods
      changed_when: false

    - name: Parse auth methods output
      ansible.builtin.set_fact:
        auth_methods_parsed: "{{ auth_methods.stdout | from_json }}"

    - name: Enable AppRole auth method
      ansible.builtin.command: vault auth enable approle
      register: vault_approle_enable_result
      changed_when: vault_approle_enable_result.changed
      when: "'approle/' not in auth_methods_parsed"

    # Step 2: Create a Policy for Secret Access
    - name: Create directory for Vault policies
      ansible.builtin.file:
        path: "{{ vault_policy_dir }}"
        state: directory
        owner: "{{ vault_user }}"
        group: "{{ vault_group }}"
        mode: "0750"

    - name: Create AppRole policy file
      ansible.builtin.copy:
        dest: "{{ vault_policy_dir }}/{{ vault_approle_policy_name }}.hcl"
        content: |
          # Read-only permission on secrets path
          path "{{ vault_name }}/data/*" {
            capabilities = ["read", "list"]
          }

          # List secrets
          path "{{ vault_name }}/metadata/*" {
            capabilities = ["list"]
          }
        owner: "{{ vault_user }}"
        group: "{{ vault_group }}"
        mode: "0640"

    - name: Write AppRole policy to Vault
      ansible.builtin.command: >
        vault policy write {{ vault_approle_policy_name }}
        {{ vault_policy_dir }}/{{ vault_approle_policy_name }}.hcl
      register: vault_policy_write_result
      changed_when: vault_policy_write_result.changed

    # Step 3: Create the AppRole
    - name: Check if AppRole exists
      ansible.builtin.command: vault list -format=json auth/approle/role
      register: approle_list
      changed_when: false
      failed_when: false

    - name: Parse AppRole list
      ansible.builtin.set_fact:
        approle_list_parsed: "{{ approle_list.stdout | from_json if approle_list.rc == 0 else [] }}"

    - name: Create AppRole
      ansible.builtin.command: >
        vault write auth/approle/role/{{ vault_approle_name }}
        token_policies={{ vault_approle_policy_name }}
        token_ttl={{ vault_approle_token_ttl }}
        token_max_ttl={{ vault_approle_token_max_ttl }}
        secret_id_ttl={{ vault_approle_secret_id_ttl }}
        secret_id_num_uses={{ vault_approle_secret_id_num_uses }}
      register: vault_approle_create_result
      changed_when: vault_approle_create_result.changed
      when: vault_approle_name not in approle_list_parsed

    # Step 4: Get Role ID and Secret ID
    - name: Create directory to store AppRole credentials
      ansible.builtin.file:
        path: "{{ vault_approle_dir }}"
        state: directory
        owner: "{{ vault_user }}"
        group: "{{ vault_group }}"
        mode: "0750"

    - name: Get Role ID
      ansible.builtin.command: vault read -format=json auth/approle/role/{{ vault_approle_name }}/role-id
      register: vault_role_id_result
      changed_when: false
      no_log: true

    - name: Parse Role ID
      ansible.builtin.set_fact:
        vault_role_id: "{{ (vault_role_id_result.stdout | from_json).data.role_id }}"
      no_log: true

    - name: Write Role ID to file
      ansible.builtin.copy:
        content: "{{ vault_role_id }}"
        dest: "{{ vault_approle_dir }}/role_id.txt"
        owner: "{{ vault_user }}"
        group: "{{ vault_group }}"
        mode: "0660"
      no_log: true

    - name: Generate Secret ID
      ansible.builtin.command: vault write -format=json -force auth/approle/role/{{ vault_approle_name }}/secret-id
      register: vault_secret_id_result
      changed_when: vault_secret_id_result.changed
      no_log: true

    - name: Parse Secret ID
      ansible.builtin.set_fact:
        vault_secret_id: "{{ (vault_secret_id_result.stdout | from_json).data.secret_id }}"
      no_log: true

    - name: Write Secret ID to file
      ansible.builtin.copy:
        content: "{{ vault_secret_id }}"
        dest: "{{ vault_approle_dir }}/secret_id.txt"
        owner: "{{ vault_user }}"
        group: "{{ vault_group }}"
        mode: "0660"
      no_log: true

# Step 5: Authenticate with AppRole (Test) - uses only VAULT_ADDR
- name: Authenticate with AppRole
  ansible.builtin.command: >
    vault write -format=json auth/approle/login
    role_id={{ vault_role_id }}
    secret_id={{ vault_secret_id }}
  environment:
    VAULT_ADDR: "{{ vault_addr }}"
  register: vault_approle_login_result
  changed_when: false
  no_log: true

- name: Parse AppRole login result
  ansible.builtin.set_fact:
    vault_approle_token: "{{ (vault_approle_login_result.stdout | from_json).auth.client_token }}"
  no_log: true

# Step 6: Verify AppRole can access secrets - uses AppRole token
- name: Verify AppRole token access
  environment:
    VAULT_ADDR: "{{ vault_addr }}"
    VAULT_TOKEN: "{{ vault_approle_token }}"
  block:
    - name: Verify AppRole token can list secrets
      ansible.builtin.command: vault kv list {{ vault_name }}
      register: vault_approle_verify_result
      changed_when: false
      failed_when: false

    - name: Read secret from itential/data/iap path to verify access
      ansible.builtin.command: vault kv get itential/iap
      register: vault_read_secret_result
      changed_when: false
      failed_when: false

- name: Verify AppRole authentication and secret access
  ansible.builtin.assert:
    that:
      - vault_approle_verify_result.rc == 0
    success_msg: >-
      AppRole '{{ vault_approle_name }}' successfully created and verified.
      Role ID and Secret ID saved to {{ vault_approle_dir }}
    fail_msg: "AppRole authentication succeeded but secret access verification failed"
