# Copyright (c) 2024, Itential, Inc
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
---
- name: Include tasks to validate variables
  ansible.builtin.include_tasks:
    file: validate-vars.yml

- name: Include tasks to validate offline variables
  ansible.builtin.include_tasks:
    file: validate-vars-offline.yml

- name: Download package from Remi repo
  when: not redis_install_from_source | bool
  block:
    - name: Include tasks to install Remi repo
      ansible.builtin.include_tasks:
        file: install-remi-repo.yml
      when:
        - redis_packages is defined
        - redis_packages is search('remi')

    - name: Download Redis rpms
      ansible.builtin.import_role:
        name: offline
        tasks_from: download-rpms
      vars:
        download_method: yum_module
        download_packages: "{{ redis_packages }}"
        download_dir: "{{ rpms_download_dir_target_node }}"

- name: Download source packages
  when: redis_install_from_source | bool
  block:
    - name: Create archives directory
      ansible.builtin.file:
        path: "{{ archives_download_dir_target_node }}"
        state: directory
        mode: '0755'

    - name: Download Redis archive
      ansible.builtin.get_url:
        url: "{{ redis_source_url }}"
        dest: "{{ archives_download_dir_target_node }}"
        mode: "0644"

    - name: Copy Redis archive to control node
      ansible.builtin.import_role:
        name: offline
        tasks_from: fetch-packages
      vars:
        src_dir: "{{ archives_download_dir_target_node }}"
        dest_dir: "{{ archives_download_dir_control_node }}"

    - name: Download Redis build rpms
      ansible.builtin.import_role:
        name: offline
        tasks_from: download-rpms
      vars:
        download_method: yum_module
        download_packages: "{{ redis_build_packages }}"
        download_dir: "{{ rpms_download_dir_target_node }}"

- name: Copy rpms to control node
  ansible.builtin.import_role:
    name: offline
    tasks_from: fetch-packages
  vars:
    src_dir: "{{ rpms_download_dir_target_node }}"
    dest_dir: "{{ rpms_download_dir_control_node }}"
