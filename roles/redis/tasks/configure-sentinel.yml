# Copyright (c) 2024, Itential, Inc
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
---
- name: Gather service facts
  ansible.builtin.service_facts:

- name: Open Sentinel port on FirewallD Public Zone
  ansible.posix.firewalld:
    port: "{{ redis_sentinel_port }}/tcp"
    permanent: true
    state: enabled
    zone: public
    immediate: true
  when:
    - ansible_facts.services["firewalld.service"] is defined
    - ansible_facts.services["firewalld.service"].state == "running"
    - ansible_facts.services["firewalld.service"].status == "enabled"

- name: Create Redis Sentinel data directory
  ansible.builtin.file:
    state: directory
    path: "{{ redis_data_dir }}/sentinel"
    owner: "{{ redis_owner }}"
    group: "{{ redis_group }}"
    mode: "0755"
    seuser: system_u
    serole: object_r
    setype: redis_var_lib_t

- name: Create Redis Sentinel systemd file
  ansible.builtin.template:
    src: redis-sentinel.service.j2
    dest: /usr/lib/systemd/system/redis-sentinel.service
    owner: root
    group: root
    mode: "0644"

- name: Set sentinel quorum
  ansible.builtin.set_fact:
    redis_sentinel_quorum_final: >-
      {{
        redis_sentinel_quorum if redis_sentinel_quorum != 'auto'
        else ((groups['redis_sentinel'] | default([]) | length / 2) | round(0, 'ceil') | int) | default(1)
      }}

- name: Validate sentinel quorum
  ansible.builtin.assert:
    that:
      - redis_sentinel_quorum_final | int >= 1
      - redis_sentinel_quorum_final | int <= (groups['redis_sentinel'] | default([]) | length)
      - groups['redis_sentinel'] | default([]) | length >= 3 or redis_sentinel_quorum != 'auto'
    fail_msg: "Invalid quorum {{ redis_sentinel_quorum_final }} for {{ groups['redis_sentinel'] | default([]) | length }} sentinels (min 3 recommended)"
    success_msg: "Sentinel quorum: {{ redis_sentinel_quorum_final }}/{{ groups['redis_sentinel'] | default([]) | length }}"
  run_once: true

- name: Display sentinel quorum configuration
  ansible.builtin.debug:
    msg: "Using sentinel quorum: {{ redis_sentinel_quorum_final }} out of {{ groups['redis_sentinel'] | default([]) | length }} sentinels"
  run_once: true

- name: Check if sentinel is running
  ansible.builtin.systemd:
    name: redis-sentinel
  register: redis_sentinel_service
  failed_when: false

- name: Stop sentinel for config update
  ansible.builtin.systemd:
    name: redis-sentinel
    state: stopped
  when: redis_sentinel_service.status.ActiveState == 'active'

- name: Deploy sentinel.conf
  ansible.builtin.template:
    src: sentinel.conf.j2
    dest: "{{ redis_sentinel_conf_file }}"
    owner: "{{ redis_owner }}"
    group: "{{ redis_group }}"
    mode: "0640"
    setype: redis_conf_t
    backup: true
  notify: Enable and Start Redis Sentinel

- name: Deploy logrotate config for Redis Sentinel
  ansible.builtin.template:
    src: redis-sentinel.logrotate.j2
    dest: /etc/logrotate.d/redis-sentinel
    owner: root
    group: root
    mode: '0644'
