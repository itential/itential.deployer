# Copyright (c) 2024, Itential, Inc
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
---
- name: Validate installation variables
  ansible.builtin.assert:
    that: >
      (iap_release is defined) or
      (redis_source_url is defined and redis_packages is not defined) or
      (redis_packages is defined and redis_source_url is not defined)
    msg: "Either iap_release must be defined, or one of [redis_source_url, redis_packages] must be defined"
  tags: always

- name: Validate installation variables when not using IAP release defaults
  when: not iap_release is defined
  tags: always
  block:
    - name: Validate redis_packages when installing from source
      ansible.builtin.assert:
        that: redis_packages is defined
        msg: "Variable redis_packages must be defined when redis_install_from_source is false"
      when: not redis_install_from_source | bool

    - name: Validate redis_source_url when installing from YUM repo
      ansible.builtin.assert:
        that: redis_source_url is defined
        msg: "Variable redis_source_url must be defined when redis_install_from_source is true"
      when: redis_install_from_source | bool

- name: Set installation variables when using IAP release defaults
  when: iap_release is defined
  tags: always
  block:
    - name: Load release default variables
      ansible.builtin.include_vars:
        file: "{{ item }}"
      with_first_found:
        - "release-{{ iap_release }}.yml"
        - "release-undefined.yml"

    - name: Check for valid Redis release
      ansible.builtin.assert:
        that: redis_invalid_release is not defined
        msg: "Deployer does not support installing Redis for IAP version {{ iap_release }}"

    - name: Set redis_source_url to the default value when not defined in inventory
      ansible.builtin.set_fact:
        redis_source_url: "{{ redis_source_url_default[ansible_distribution_major_version] }}"
      when:
        - redis_source_url is not defined
        - redis_install_from_source | bool

    - name: Set redis_packages to the default value when not defined in inventory
      ansible.builtin.set_fact:
        redis_packages: "{{ redis_packages_default[ansible_distribution_major_version] }}"
      when:
        - redis_packages is not defined
        - not redis_install_from_source | bool

- name: Print installation details for online installation
  when: not offline_install
  block:
    - name: Print installation details when installing from source
      ansible.builtin.debug:
        msg: "Installing from source URL {{ redis_source_url }}"
      when: redis_source_url is defined

    - name: Print installation details when installing from repo
      ansible.builtin.debug:
        msg: "Installing RPMs {{ redis_packages }}"
      when: redis_packages is defined
