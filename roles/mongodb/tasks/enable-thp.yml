# Copyright (c) 2024, Itential, Inc
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
---
# Transparent Hugepages (THP) is a Linux memory management system that reduces the overhead
# of Translation Lookaside Buffer (TLB) lookups. THP achieves this by combining small pages
# and making them appear as larger memory pages to the application.
#
# In MongoDB 8.0 and later, ensure that THP is enabled before mongod starts by creating a
# service file for your platform's initialization system.
#
# Additionally, for RHEL and CentOS systems that use ktune and tuned performance profiles,
# you must also create a custom tuned profile.
#
# Check if its already enabled
- name: Ensure THP is enabled always
  ansible.builtin.lineinfile:
    name: /sys/kernel/mm/transparent_hugepage/enabled
    line: "[always] madvise never"
    state: present
  check_mode: true
  register: thp_enable_conf

- name: Ensure THP is defrag always
  ansible.builtin.lineinfile:
    name: /sys/kernel/mm/transparent_hugepage/defrag
    line: "always defer [defer+madvise] madvise never"
    state: present
  check_mode: true
  register: thp_defrag_conf
