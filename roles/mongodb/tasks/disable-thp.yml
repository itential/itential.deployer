# Copyright (c) 2024, Itential, Inc
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
---
# MongoDB 7 and below!
#
# Transparent Huge Pages (THP) is a Linux memory management system that reduces the overhead
# of Translation Lookaside Buffer (TLB) lookups on machines with large amounts of memory by
# using larger memory pages.
#
# However, database workloads often perform poorly with THP enabled, because they tend to
# have sparse rather than contiguous memory access patterns. When running MongoDB on Linux,
# THP should be disabled for best performance.
#
# To ensure that THP is disabled before mongod starts, you should create a service file for
# your platform's initialization system that disables THP at boot. Instructions are provided
# below for both the systemd and the System V init initialization systems.

# Check if its already disabled
- name: Ensure THP is enabled never
  ansible.builtin.lineinfile:
    name: /sys/kernel/mm/transparent_hugepage/enabled
    line: "always madvise [never]"
    state: present
  check_mode: true
  register: thp_enable_conf

- name: Ensure THP is defrag never
  ansible.builtin.lineinfile:
    name: /sys/kernel/mm/transparent_hugepage/defrag
    line: "always defer defer+madvise madvise [never]"
    state: present
  check_mode: true
  register: thp_defrag_conf
